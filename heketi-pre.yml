---
# Ansible for installing GlusterFS requirements on K8s cluster machines.

- hosts: '*'
  vars:
    gluster_repo: 'ppa:gluster/glusterfs-3.12'
    glusterfs_client_vers: '3.12.8-ubuntu1~xenial1'
  remote_user: solidfire
  become: true

  tasks:

  #- name: Role Facts
  #  set_fact:
  #    block_device: '/dev/sdb'

  - name: Run iptables for Heketi
    script: gluster-iptables.sh

  - name: Install Kernel Modules
    modprobe:
      name: "{{ item }}"
      state: present
    with_items:
      - dm_snapshot
      - dm_mirror
      - dm_thin_pool

  - name: Install Kernel Modules dm_snapshot
    lineinfile:
      dest: /etc/modules
      state: present
      regexp: '^dm_snapshot '
      line: 'dm_snapshot'

  - name: Install Kernel Modules dm_mirror
    lineinfile:
      dest: /etc/modules
      state: present
      regexp: '^dm_mirror '
      line: 'dm_mirror'

  - name: Install Kernel Modules dm_thin_pool
    lineinfile:
      dest: /etc/modules
      state: present
      regexp: '^dm_thin_pool '
      line: 'dm_thin_pool'

  - name: Add Apt Repo
    shell: |
      add-apt-repository "{{ gluster_repo }}"
      apt-get update

  - name: Install Packages
    apt: 
      name: "glusterfs-client={{ glusterfs_client_vers }}"
